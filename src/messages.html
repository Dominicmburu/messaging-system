<!DOCTYPE html>
<html>
<head>
  <title>Messages | Company Portal</title>
  <link rel="stylesheet" href="./css/styles.css" />
</head>
<body>
  <nav>
    <a href="employees.html">Employees</a>
    <a href="messages.html">Messages</a>
    <a href="#" id="logout">Logout</a>
  </nav>

  <div class="container">
    <h1>Messaging</h1>
    <div id="alert"></div>

    <div id="messagesContainer" style="max-height: 300px; overflow-y: auto; border: 1px solid #ccc;">
      <!-- Messages will appear here -->
    </div>

    <form id="messageForm">
      <h2>Send Message</h2>
      <label for="toEmail">To</label>
      <input type="text" id="toEmail" required />
      <label for="msgBody">Message</label>
      <input type="text" id="msgBody" required />
      <button type="submit">Send</button>
    </form>
  </div>

  <script src="./js/main.js"></script>
  <script>
    const logoutLink = document.getElementById('logout');
    const alertDiv = document.getElementById('alert');
    const messagesContainer = document.getElementById('messagesContainer');
    const messageForm = document.getElementById('messageForm');
    const userEmail = localStorage.getItem('userEmail');

    if (!userEmail) {
      alert('Please log in first');
      window.location.href = 'index.html';
    }

    // Logout
    logoutLink.addEventListener('click', () => {
      localStorage.clear();
      window.location.href = 'index.html';
    });

    // Fetch messages for the logged in user
    async function loadMessages() {
      try {
        const res = await fetch(`${BASE_URL}/api/messages?userEmail=${userEmail}`);
        const data = await res.json();
        messagesContainer.innerHTML = '';

        data.forEach(msg => {
          const msgDiv = document.createElement('div');
          msgDiv.style.border = '1px solid #ddd';
          msgDiv.style.margin = '5px';
          msgDiv.style.padding = '5px';
          msgDiv.innerHTML = `
            <p><strong>From:</strong> ${msg.from}</p>
            <p><strong>To:</strong> ${msg.to}</p>
            <p>${msg.message}</p>
            <small>${new Date(msg.timestamp).toLocaleString()}</small>
          `;
          messagesContainer.appendChild(msgDiv);
        });
      } catch (err) {
        messagesContainer.innerHTML = `<div class="alert error">Error loading messages</div>`;
      }
    }

    // Send message
    messageForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const to = document.getElementById('toEmail').value;
      const messageBody = document.getElementById('msgBody').value;

      try {
        const res = await fetch(`${BASE_URL}/api/messages`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            from: userEmail,
            to,
            message: messageBody,
          }),
        });
        const data = await res.json();
        if (!res.ok) {
          throw new Error(data.message || 'Failed to send message');
        }
        alertDiv.innerHTML = `<div class="alert success">Message sent</div>`;
        // Clear form
        document.getElementById('toEmail').value = '';
        document.getElementById('msgBody').value = '';
        // Reload messages
        loadMessages();
      } catch (err) {
        alertDiv.innerHTML = `<div class="alert error">${err.message}</div>`;
      }
    });

    // Poll for new messages every 5 seconds
    loadMessages();
    setInterval(loadMessages, 5000);
  </script>
</body>
</html>
