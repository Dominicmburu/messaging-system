<!DOCTYPE html>
<html>
<head>
  <title>Employees | Company Portal</title>
  <link rel="stylesheet" href="./css/styles.css" />
</head>
<body>
  <nav>
    <a href="employees.html">Employees</a>
    <a href="messages.html">Messages</a>
    <a href="#" id="logout">Logout</a>
  </nav>

  <div class="container">
    <h1>Employee Management</h1>
    <div id="alert"></div>

    <h2>Create Employee</h2>
    <form id="createForm">
      <input type="text" id="name" placeholder="Name" required />
      <input type="text" id="department" placeholder="Department" required />
      <input type="text" id="position" placeholder="Position" required />
      <input type="text" id="salary" placeholder="Salary" required />
      <button type="submit">Create</button>
    </form>

    <h2>All Employees</h2>
    <div id="employeesList"></div>
  </div>

  <script src="./js/main.js"></script>
  <script>
    const alertDiv = document.getElementById('alert');
    const createForm = document.getElementById('createForm');
    const employeesList = document.getElementById('employeesList');
    const logoutLink = document.getElementById('logout');

    // Check if user is Admin or Manager
    const role = localStorage.getItem('userRole');
    if (role !== 'Admin' && role !== 'Manager') {
      alert('Access denied!');
      window.location.href = 'index.html';
    }

    // Logout
    logoutLink.addEventListener('click', () => {
      localStorage.clear();
      window.location.href = 'index.html';
    });

    // CREATE EMPLOYEE
    createForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      alertDiv.innerHTML = '';

      const newEmployee = {
        name: document.getElementById('name').value,
        department: document.getElementById('department').value,
        position: document.getElementById('position').value,
        salary: document.getElementById('salary').value,
      };

      try {
        const res = await fetch(`${BASE_URL}/api/employees`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(newEmployee),
        });
        const data = await res.json();
        if (!res.ok) {
          throw new Error(data.message || 'Failed to create employee');
        }
        alertDiv.innerHTML = `<div class="alert success">Employee Created with ID: ${data.id}</div>`;
        // Reload employee list
        loadEmployees();
      } catch (err) {
        alertDiv.innerHTML = `<div class="alert error">${err.message}</div>`;
      }
    });

    // LOAD EMPLOYEES
    async function loadEmployees() {
      employeesList.innerHTML = 'Loading...';
      try {
        const res = await fetch(`${BASE_URL}/api/employees`);
        const data = await res.json();
        employeesList.innerHTML = '';

        data.forEach(emp => {
          const empDiv = document.createElement('div');
          empDiv.style.border = '1px solid #ccc';
          empDiv.style.margin = '5px';
          empDiv.style.padding = '5px';

          empDiv.innerHTML = `
            <p><strong>ID:</strong> ${emp.id} </p>
            <p><strong>Name:</strong> ${emp.name} </p>
            <p><strong>Username:</strong> ${emp.username} </p>
            <p><strong>Email:</strong> ${emp.email} </p>
            <!-- The fields from JSONPlaceholder vary; weâ€™re just showing some. -->
            <button data-id="${emp.id}" class="updateBtn">Update</button>
            <button data-id="${emp.id}" class="deleteBtn">Delete</button>
          `;

          employeesList.appendChild(empDiv);
        });

        // Attach event listeners for update and delete
        document.querySelectorAll('.updateBtn').forEach(btn => {
          btn.addEventListener('click', () => {
            const id = btn.dataset.id;
            const newName = prompt('Enter new name:');
            if (newName) updateEmployee(id, { name: newName });
          });
        });

        document.querySelectorAll('.deleteBtn').forEach(btn => {
          btn.addEventListener('click', () => {
            const id = btn.dataset.id;
            if (confirm('Are you sure you want to delete this employee?')) {
              deleteEmployee(id);
            }
          });
        });

      } catch (err) {
        employeesList.innerHTML = `<div class="alert error">Failed to load employees</div>`;
      }
    }

    // UPDATE EMPLOYEE
    async function updateEmployee(id, updatedData) {
      try {
        const res = await fetch(`${BASE_URL}/api/employees/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updatedData),
        });
        const data = await res.json();

        if (!res.ok) {
          throw new Error(data.message || 'Failed to update employee');
        }
        alertDiv.innerHTML = `<div class="alert success">Employee Updated</div>`;
        loadEmployees();
      } catch (err) {
        alertDiv.innerHTML = `<div class="alert error">${err.message}</div>`;
      }
    }

    // DELETE EMPLOYEE
    async function deleteEmployee(id) {
      try {
        const res = await fetch(`${BASE_URL}/api/employees/${id}`, {
          method: 'DELETE',
        });
        if (!res.ok) {
          throw new Error('Failed to delete employee');
        }
        alertDiv.innerHTML = `<div class="alert success">Employee Deleted</div>`;
        loadEmployees();
      } catch (err) {
        alertDiv.innerHTML = `<div class="alert error">${err.message}</div>`;
      }
    }

    // Initialize
    loadEmployees();
  </script>
</body>
</html>
